<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Testing data | Decarbonisation Glyphmap Planner</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air,near-midnight.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air,near-midnight.css">
<link rel="modulepreload" href="./_observablehq/client.js">
<link rel="modulepreload" href="./_observablehq/runtime.js">
<link rel="modulepreload" href="./_observablehq/stdlib.js">
<link rel="modulepreload" href="./_import/components/timeGlyph.17d99791.js">
<link rel="modulepreload" href="./_import/components/model.41b0b50e.js">
<link rel="modulepreload" href="./_npm/d3@7.9.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-array@3.2.4/_esm.js">
<link rel="modulepreload" href="./_npm/d3-axis@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-brush@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-chord@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-color@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-contour@4.0.2/_esm.js">
<link rel="modulepreload" href="./_npm/d3-delaunay@6.0.4/_esm.js">
<link rel="modulepreload" href="./_npm/d3-dispatch@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-drag@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-ease@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-fetch@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-force@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-format@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-hierarchy@3.1.2/_esm.js">
<link rel="modulepreload" href="./_npm/d3-interpolate@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-path@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-polygon@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-quadtree@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-random@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-scale@4.0.2/_esm.js">
<link rel="modulepreload" href="./_npm/d3-scale-chromatic@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-selection@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-shape@3.2.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-time@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-time-format@4.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-timer@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-transition@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-zoom@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/internmap@2.0.3/_esm.js">
<link rel="modulepreload" href="./_npm/delaunator@5.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/robust-predicates@3.0.2/_esm.js">
<script type="module">

import {define} from "./_observablehq/client.js";
import {registerFile} from "./_observablehq/stdlib.js";

registerFile("./data/result_gdf_admin.geojson", {"name":"./data/result_gdf_admin.geojson","mimeType":"application/geo+json","path":"./data/result_gdf_admin.geojson"});

define({id: "134bb80b", outputs: ["TimeGlyph","GlyphCollection","Model"], body: async () => {
const [{TimeGlyph, GlyphCollection}, {Model}] = await Promise.all([import("./_import/components/timeGlyph.17d99791.js"), import("./_import/components/model.41b0b50e.js")]);

return {TimeGlyph,GlyphCollection,Model};
}});

define({id: "a9a4e27a", mode: "inline", inputs: ["resize","createCanvas","display"], body: async (resize,createCanvas,display) => {
display(await(
resize((width, height) => createCanvas(width, height))
))
}});

define({id: "53a6a2ae", inputs: ["modelData","Model","GlyphCollection","d3","TimeGlyph"], outputs: ["createCanvas"], body: (modelData,Model,GlyphCollection,d3,TimeGlyph) => {
function createCanvas(width, height) {
    
    
    //MODEL BUILDING
    
    //repack actual data in a more compact format
    let buildings = modelData.features.map( b => ({
        lsoa : b.properties["LSOA code"],
        msoa : b.properties["MSOA code"],
        building_area : b.properties["Air Source Heat Pump Potential_Building Size (m^2)"],
        garden_area : b.properties["Air Source Heat Pump Potential_Garden Area (m^2)"],
        ashp_suitability : b.properties["Air Source Heat Pump Potential_Overall Suitability Rating"],
        ashp_size : b.properties["Air Source Heat Pump Potential_Recommended Heat Pump Size [kW]"],
        ashp_labour : b.properties["Low Carbon Technology Costs_Air Source Heat Pump - Labour"],
        ashp_material : b.properties["Low Carbon Technology Costs_Air Source Heat Pump - Material"],
        ashp_total : b.properties["Low Carbon Technology Costs_Air Source Heat Pump - Total"],
        gshp_suitability : b.properties["Domestic Ground Source Heat Pump Potential_Overall Suitability Rating"], 
        gshp_size : b.properties["Domestic Ground Source Heat Pump Potential_Recommended Heat Pump Size [kW]"],
        gshp_labour : b.properties["Low Carbon Technology Costs_Ground Source Heat Pump - Labour"],
        gshp_material : b.properties["Low Carbon Technology Costs_Ground Source Heat Pump - Materials"],
        gshp_total : b.properties["Low Carbon Technology Costs_Ground Source Heat Pump - Total"],        
        heat_demand : b.properties["Domestic Heat Demand_Annual Heat Demand (kWh)"],
        insulation_rating :  b.properties["Domestic Insulation Potential_EPC Rating"],
        insulation_cwall: b.properties["Domestic Insulation Potential_Insulation - Cavity Wall"],
        insulation_cwall_labour : b.properties["Low Carbon Technology Costs_Insulation - Cavity Wall - Labour"],
        insulation_cwall_materials : b.properties["Low Carbon Technology Costs_Insulation - Cavity Wall  - Materials"],
        insulation_cwall_total : b.properties["Low Carbon Technology Costs_Insulation - Cavity Wall - Total"],
        insulation_ewall : b.properties["Domestic Insulation Potential_Insulation - External Wall"],
        insulation_ewall_labour : b.properties["Low Carbon Technology Costs_Insulation - External Wall - Labour"],
        insulation_ewall_materials : b.properties["Low Carbon Technology Costs_Insulation - External Wall - Material"],
        insulation_ewall_total : b.properties["Low Carbon Technology Costs_Insulation - External Wall - Total"],
        insulation_roof : b.properties["Domestic Insulation Potential_Insulation - Roof"],
        insulation_roof_labour : b.properties["Low Carbon Technology Costs_Insulation - Loft - Labour"],
        insulation_roof_materials : b.properties["Low Carbon Technology Costs_Insulation - Loft - Material"],
        insulation_roof_total : b.properties["Low Carbon Technology Costs_Insulation - Loft - Total"],
        insulation_floor : b.properties["Domestic Insulation Potential_Insulation - Under Floor"],
        insulation_floor_labour : b.properties["Low Carbon Technology Costs_Insulation - Under Floor - Labour"],
        insulation_floor_materials : b.properties["Low Carbon Technology Costs_Insulation - Under Floor - Material"],
        insulation_floor_total : b.properties["Low Carbon Technology Costs_Insulation - Under Floor- Total"],
        pv_suitability : b.properties["Domestic PV Potential_Overall Suitability"],
        pv_size : b.properties["Domestic PV Potential_Recommended Array Size [kW]"],
        pv_generation : b.properties["Domestic PV Potential_Annual Generation [kWh]"],
        pv_labour : b.properties["Low Carbon Technology Costs_Rooftop PV - Labour"],
        pv_material : b.properties["Low Carbon Technology Costs_Rooftop PV - Materials"],
        pv_total : b.properties["Low Carbon Technology Costs_Rooftop PV - Total"],
    }));
    
    //configure model specifications (for now only two tech, ASHP and PV, hardcoded)
    let modelSpec = {
        nr_years : 10,
        yearly_funding : 300000000,
        tech_allocation : {ASHP : 0.5, PV : 0.5}};
    
    //create (and run) model
    let model = new Model(buildings,modelSpec);
   
    
    
    //CREATE CANVAS AND GLYPHS
    let canvas = document.createElement("canvas");
    let ctx = canvas.getContext("2d");
    canvas.width = width;
    canvas.height = width;
    
    
    //to support global normalisations and, in the future, mirrored interactions
    let glyphCollection = new GlyphCollection();
    
    
    //we start prepping the data that goes into the glyphs
    
    //we group interventions first by lsoa, then technology, then year
    let lsoaTechYear = model.getInterventions().groupBy("lsoa").groupBy("type").groupBy("year").all();
    console.log("Interventions (grouped lsoa->tech->year)", lsoaTechYear);
    
    //get building data at each simulation year, split by lsoa
    let buildingsYearLsoas = d3.range(modelSpec.nr_years).map( y =>
                    model.getBuildings(y).groupBy("lsoa").all());
    console.log("Buildings by year (grouped lsoa)", buildingsYearLsoas);
    
    
    //prepare glyphs, for now two options: 
    //1. show all technologies (ASHP and PV for now) stacked on top of each other,
    //either cummulatively or not (allTech = true)
    //2. show one tech (ASHP for now) with yearly savings and cummulative potential for saving (allTech = false)
    
    let allTech = false; //allTech will show all technologies as stacked time chart
                        //!allTech will show ASHP saved and potential    
    let cummulative = false; //cummulative savings?
    //only used when !allTech
    let sqrt = true; // potential for saving is much larger than actual saving and 
                        //showing it in sqrt scale might be handy
    let stacked = false; //stacked=false (overlaid) is better for non-cummulative, !allTech, overlaid is better
    
    
    //so, best config:
    if (allTech){
        cummulative = false; stacked = true;
    }
    else{
        cummulative = false; sqrt = true; stacked = false;
    }
    
    Object.keys(lsoaTechYear).map( (lsoaCode,i) => {
        
        let lsoa = lsoaTechYear[lsoaCode];

        let glyphData = new Object();
        
        
        //stacked glyph with the saved MW for all categories
        if (allTech)
            Object.keys(modelSpec.tech_allocation).map( tech =>
                glyphData[tech] = d3.range(modelSpec.nr_years).map( year => 
                    lsoa[tech][year]==null ? 0 : d3.sum(lsoa[tech][year].map( i => i.saved))));

        //stacked glyph with the actual saved MW vs. total saving potential
        else {
            //potential saving by year by this tech (this potential keeps decreasing
            //as more and more buildings have been upgraded)
            glyphData["potential"] = d3.range(modelSpec.nr_years).map(year =>
                d3.sum(buildingsYearLsoas[year][lsoaCode].filter(b => b.ashp_suitability).map(b => b.heat_demand)));
            if (sqrt) glyphData["potential"] = glyphData["potential"].map(v => Math.sqrt(v));

            //for a particular tech
            let tech = "ASHP";
            //cummulative savings over years by this tech
            let sum = 0;
            glyphData[tech] = d3.range(modelSpec.nr_years).map(year => {
                if (cummulative)
                    sum += lsoa[tech][year] == null ? 0 : d3.sum(lsoa[tech][year].map(i => i.saved));
                else sum = lsoa[tech][year] == null ? 0 : d3.sum(lsoa[tech][year].map(i => i.saved));
                return sum;
            });
            if (sqrt) glyphData[tech] = glyphData[tech].map(v => Math.sqrt(v));
        }
        
        let tg = new TimeGlyph(glyphData, glyphCollection, stacked);
        glyphCollection.add(tg);
    });
    
    
    glyphCollection.recalculate = function(){
        glyphCollection.norm = d3.max(this.glyphs.map( g => g.maxAllTime()));
        console.log("norm val: " + glyphCollection.norm);
    };
    glyphCollection.recalculate();
    
    console.log(glyphCollection.glyphs);
    glyphCollection.glyphs.map( (g,i) =>
        g.draw(ctx, Math.floor(i/10)*50, (i%10)*50, 40, 50)    
    );
    
    
    
    
    return canvas;
}
return {createCanvas};
}});

define({id: "43143476", inputs: ["FileAttachment"], outputs: ["modelData"], body: (FileAttachment) => {
const modelData = FileAttachment("./data/result_gdf_admin.geojson").json();
return {modelData};
}});

</script>
<div id="observablehq-center">
<main id="observablehq-main" class="observablehq">
<div class="observablehq observablehq--block"><!--:134bb80b:--></div>
<!-------- Stylesheets -------->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
<style>
body, html {
  height: 100%;
  margin: 0 !important;
  overflow: hidden;
  padding: 0;
}

#observablehq-main, #observablehq-header, #observablehq-footer {
    margin: 0 !important;
    /* width: 100% !important; */
    max-width: 100% !important;
}

/* Make the entire section fill the viewport */
.section {
  height: 90vh !important; /* Full height of the viewport */
  padding: 0;
}

.container {
  margin: 0 !important;
  max-width: 100% !important;
}

/* Make the columns stretch to the full height of the viewport */
.columns {
  height: 100%;
  margin: 0;
}

/* Ensure the column boxes fit inside the layout */
.column {
  display: flex;
  flex-direction: column;
}

/* Ensure the boxes inside left column take full height */
.column.is-one-third .box {
  flex: 1; /* Make the boxes in the left column flexible */
  margin-bottom: 0.5rem; /* Add some spacing between boxes */
}

/* For the right column, ensure the box takes up full height */
.column.is-two-thirds .box {
  height: calc(90vh - 2rem); /* Subtract section padding or any margin if needed */
}
</style>
<section class="section">
    <div class="container">
      <div class="columns">
        <!-- Left Column (5 boxes) -->
        <div class="column is-one-third" style="margin: 0 !important; padding: 0 !important;">
          <div class="columns is-multiline">
            <div class="column is-full">
              <div class="box">Box 4</div>
            </div>
            <div class="column is-full">
              <div class="box">Box 5</div>
            </div>
          </div>
        </div>
        <!-- Right Column (Main Content) -->
        <div class="column is-two-thirds">
          <div id="main-area" class="box">
            <observablehq-loading></observablehq-loading><!--:a9a4e27a:-->
          </div>
        </div>
      </div>
    </div>
  </section>
<div class="observablehq observablehq--block"><!--:53a6a2ae:--></div>
<div class="observablehq observablehq--block"><!--:43143476:--></div>
</main>
</div>
