<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Custom Dashboard Widgets | Decarbonisation Glyphmap Planner</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air,near-midnight.css">
<link rel="preload" as="style" href="./_observablehq/stdlib/inputs.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air,near-midnight.css">
<link rel="stylesheet" type="text/css" href="./_observablehq/stdlib/inputs.css">
<link rel="modulepreload" href="./_observablehq/client.js">
<link rel="modulepreload" href="./_observablehq/runtime.js">
<link rel="modulepreload" href="./_observablehq/stdlib.js">
<link rel="modulepreload" href="./_import/components/budgetAllocator.fc30d0c8.js">
<link rel="modulepreload" href="./_import/components/miniDecarbModel.1d241d4e.js">
<link rel="modulepreload" href="./_npm/d3@7.9.0/_esm.js">
<link rel="modulepreload" href="./_observablehq/stdlib/duckdb.js">
<link rel="modulepreload" href="./_observablehq/stdlib/inputs.js">
<link rel="modulepreload" href="./_npm/@duckdb/duckdb-wasm@1.28.0/_esm.js">
<link rel="modulepreload" href="./_npm/htl@0.3.1/_esm.js">
<link rel="modulepreload" href="./_npm/isoformat@0.2.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-array@3.2.4/_esm.js">
<link rel="modulepreload" href="./_npm/d3-axis@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-brush@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-chord@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-color@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-contour@4.0.2/_esm.js">
<link rel="modulepreload" href="./_npm/d3-delaunay@6.0.4/_esm.js">
<link rel="modulepreload" href="./_npm/d3-dispatch@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-drag@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-ease@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-fetch@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-force@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-format@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-hierarchy@3.1.2/_esm.js">
<link rel="modulepreload" href="./_npm/d3-interpolate@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-path@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-polygon@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-quadtree@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-random@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-scale@4.0.2/_esm.js">
<link rel="modulepreload" href="./_npm/d3-scale-chromatic@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-selection@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-shape@3.2.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-time@3.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-time-format@4.1.0/_esm.js">
<link rel="modulepreload" href="./_npm/d3-timer@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-transition@3.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/d3-zoom@3.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/apache-arrow@18.0.0/_esm.js">
<link rel="modulepreload" href="./_npm/internmap@2.0.3/_esm.js">
<link rel="modulepreload" href="./_npm/delaunator@5.0.1/_esm.js">
<link rel="modulepreload" href="./_npm/tslib@2.8.1/_esm.js">
<link rel="modulepreload" href="./_npm/flatbuffers@24.3.25/_esm.js">
<link rel="modulepreload" href="./_npm/robust-predicates@3.0.2/_esm.js">
<script type="module">

import {define} from "./_observablehq/client.js";
import {registerFile, FileAttachment} from "./_observablehq/stdlib.js";
import {registerTable} from "./_observablehq/stdlib/duckdb.js";

registerFile("./data/oxford_decarbonisation_data.parquet", {"name":"./data/oxford_decarbonisation_data.parquet","path":"./_file/data/oxford_decarbonisation_data.28ee7510.parquet","lastModified":1731194509384});
registerTable("oxford", FileAttachment("./data/oxford_decarbonisation_data.parquet"));

define({id: "08571958", outputs: ["BudgetAllocator","MiniDecarbModel"], body: async () => {
const [{BudgetAllocator}, {MiniDecarbModel}] = await Promise.all([import("./_import/components/budgetAllocator.fc30d0c8.js"), import("./_import/components/miniDecarbModel.1d241d4e.js")]);

return {BudgetAllocator,MiniDecarbModel};
}});

define({id: "0c4fdd7c", inputs: ["BudgetAllocator","display"], outputs: ["totalBudget","startYear","projectLength","allocator","linearAllocation"], body: (BudgetAllocator,display) => {
const totalBudget = 100_000;
const startYear = 2024;
const projectLength = 10;

const allocator = new BudgetAllocator(totalBudget, startYear, projectLength);

// linear allocation
const linearAllocation = allocator.allocateLinear();
display(linearAllocation);
display(allocator.visualize(linearAllocation));
// console.log(allocator.visualize(linearAllocation));
// document.body.appendChild(allocator.visualize(linearAllocation));

// // custom allocation with different curve types
// const logAllocation = allocator.allocateCustom("sqrt");
// console.log("sqrt    Allocation Recap:", allocator.allocation(logAllocation));

// const expAllocation = allocator.allocateCustom("exp", { exponent: 2 });
// display(expAllocation);
// display(allocator.visualize(expAllocation));

// // console.log(
// //   "Exponential Allocation Recap:",
// //   allocator.allocation(expAllocation)
// // );

// const sigmoid = allocator.allocateBudget("sigmoid", false);
// const sigmoid = allocator.allocateCustom("cubic");
// display(cubicAllocation);
// display(allocator.visualize(sigmoid));

// console.log("Cubic Allocation Recap:", allocator.allocation(cubicAllocation));
return {totalBudget,startYear,projectLength,allocator,linearAllocation};
}});

define({id: "031eeacd", inputs: ["display","Inputs","sql"], outputs: ["oxford_data"], body: async (display,Inputs,sql) => {
const oxford_data = ((_) => (display(Inputs.table(_)), _))(await sql`  SELECT DISTINCT
    "UPRN" AS id,
    "LSOA code" AS lsoa,
    "MSOA code" AS msoa,
    "Air Source Heat Pump Potential_Building Size (m^2)" AS building_area,
    "Air Source Heat Pump Potential_Garden Area (m^2)" AS garden_area,
    "Air Source Heat Pump Potential_Overall Suitability Rating" AS ashp_suitability,
    "Air Source Heat Pump Potential_Recommended Heat Pump Size [kW]" AS ashp_size,
    "Low Carbon Technology Costs_Air Source Heat Pump - Labour" AS ashp_labour,
    "Low Carbon Technology Costs_Air Source Heat Pump - Material" AS ashp_material,
    "Low Carbon Technology Costs_Air Source Heat Pump - Total" AS ashp_total,
    "Domestic Ground Source Heat Pump Potential_Overall Suitability Rating" AS gshp_suitability,
    "Domestic Ground Source Heat Pump Potential_Recommended Heat Pump Size [kW]" AS gshp_size,
    "Low Carbon Technology Costs_Ground Source Heat Pump - Labour" AS gshp_labour,
    "Low Carbon Technology Costs_Ground Source Heat Pump - Materials" AS gshp_material,
    "Low Carbon Technology Costs_Ground Source Heat Pump - Total" AS gshp_total,
    "Domestic Heat Demand_Annual Heat Demand (kWh)" AS heat_demand,
    "Domestic Insulation Potential_EPC Rating" AS insulation_rating,
    "Domestic Insulation Potential_Insulation - Cavity Wall" AS insulation_cwall,
    "Low Carbon Technology Costs_Insulation - Cavity Wall - Labour" AS insulation_cwall_labour,
    "Low Carbon Technology Costs_Insulation - Cavity Wall  - Materials" AS insulation_cwall_materials,
    "Low Carbon Technology Costs_Insulation - Cavity Wall - Total" AS insulation_cwall_total,
    "Domestic Insulation Potential_Insulation - External Wall" AS insulation_ewall,
    "Low Carbon Technology Costs_Insulation - External Wall - Labour" AS insulation_ewall_labour,
    "Low Carbon Technology Costs_Insulation - External Wall - Material" AS insulation_ewall_materials,
    "Low Carbon Technology Costs_Insulation - External Wall - Total" AS insulation_ewall_total,
    "Domestic Insulation Potential_Insulation - Roof" AS insulation_roof,
    "Low Carbon Technology Costs_Insulation - Loft - Labour" AS insulation_roof_labour,
    "Low Carbon Technology Costs_Insulation - Loft - Material" AS insulation_roof_materials,
    "Low Carbon Technology Costs_Insulation - Loft - Total" AS insulation_roof_total,
    "Domestic Insulation Potential_Insulation - Under Floor" AS insulation_floor,
    "Low Carbon Technology Costs_Insulation - Under Floor - Labour" AS insulation_floor_labour,
    "Low Carbon Technology Costs_Insulation - Under Floor - Material" AS insulation_floor_materials,
    "Low Carbon Technology Costs_Insulation - Under Floor- Total" AS insulation_floor_total,
    "Domestic PV Potential_Overall Suitability" AS pv_suitability,
    "Domestic PV Potential_Recommended Array Size [kW]" AS pv_size,
    "Domestic PV Potential_Annual Generation [kWh]" AS pv_generation,
    "Low Carbon Technology Costs_Rooftop PV - Labour" AS pv_labour,
    "Low Carbon Technology Costs_Rooftop PV - Materials" AS pv_material,
    "Low Carbon Technology Costs_Rooftop PV - Total" AS pv_total,
    "Substation Name" AS substation_name,
    "Substation - CapacityRating" AS substation_capacity_rating,
    "Substation - Peakload" AS substation_peakload,
    "Substation - Headroom" AS substation_headroom,
    "Substation - % headroom" AS substation_headroom_pct,
    "Substation - Demand_rag" AS substation_demand
FROM oxford b;`);
return {oxford_data};
}});

define({id: "e990e608", inputs: ["oxford_data"], outputs: ["newBuildings"], body: (oxford_data) => {
const newBuildings = [...oxford_data];
return {newBuildings};
}});

define({id: "c0938516", inputs: ["MiniDecarbModel","newBuildings","display"], outputs: ["configASHP","modelASHP","results"], body: (MiniDecarbModel,newBuildings,display) => {
const configASHP = {
  initial_year: 2024,
  rolledover_budget: 50_000_000,
  yearly_budgets: [1200000, 30000, 20000, 5000, 3000, 20000], // this will be assigned from budgetAllocator
  tech: {
    name: "ASHP",
    config: {
      suitabilityKey: "ashp_suitability",
      labourKey: "ashp_labour",
      materialKey: "ashp_material",
      savingsKey: "heat_demand", // will be calculated from a lookup and stored in the building data
    },
  },
  priorities: [
    {
      name: "substation_headroom", //sort by substation headroom
      order: "asc",
    },
  ],
};

// For priority rules:
// // Categorical priority
// model.addPriorityRuleCustom({
//   attribute: 'multideprivation',
//   scoreFunction: (value) => ({
//     'deprived': 1000,
//     'not-deprived': 0
//   })[value] || 0
// });

// // Numeric threshold priority
// model.addPriorityRuleCustom({
//   attribute: 'fuel_poverty',
//   scoreFunction: (value) => value > 0.5 ? 500 : 0,
//   weight: 2.0
// });

// // Complex scoring function
// model.addPriorityRuleCustom({
//   attribute: 'energy_rating',
//   scoreFunction: (value) => {
//     const ratings = {'A': 0, 'B': 200, 'C': 400, 'D': 600, 'E': 800, 'F': 1000};
//     return ratings[value] || 0;
//   }
// });
const modelASHP = new MiniDecarbModel(configASHP, newBuildings);
modelASHP.addBuildingFilter(
  (b) => b.properties["substation_headroom"] >= 500,
  "Substation Headroom >= 500"
);

modelASHP.addPriorityRuleCustom({
  attribute: "substation_capacity_rating",
  scoreFunction: (value) =>
    ({
      800: 500,
      1500: 1000,
    }[value] || 0),
});

modelASHP.runModel();
const results = modelASHP.getRecap();
display(results);
return {configASHP,modelASHP,results};
}});

define({id: "216be021", inputs: ["display","Inputs","results"], body: (display,Inputs,results) => {
display(Inputs.table(results.allBuildings));
}});

</script>
<div id="observablehq-center">
<main id="observablehq-main" class="observablehq">
<div class="observablehq observablehq--block"><!--:08571958:--></div>
<h2 id="budget-allocator" tabindex="-1"><a class="observablehq-header-anchor" href="#budget-allocator">Budget Allocator</a></h2>
<div class="observablehq observablehq--block"><!--:0c4fdd7c:--></div>
<h2 id="test-new-model" tabindex="-1"><a class="observablehq-header-anchor" href="#test-new-model">Test New Model</a></h2>
<div class="observablehq observablehq--block"><!--:031eeacd:--></div>
<div class="observablehq observablehq--block"><!--:e990e608:--></div>
<div class="observablehq observablehq--block"><!--:c0938516:--></div>
<div class="observablehq observablehq--block"><!--:216be021:--></div>
</main>
</div>
