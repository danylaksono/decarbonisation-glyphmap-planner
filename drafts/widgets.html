<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Custom Dashboard Widgets | Decarbonisation Glyphmap Planner</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="../_observablehq/theme-air,near-midnight.css">
<link rel="preload" as="style" href="../_observablehq/stdlib/inputs.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="../_observablehq/theme-air,near-midnight.css">
<link rel="stylesheet" type="text/css" href="../_observablehq/stdlib/inputs.css">
<link rel="modulepreload" href="../_observablehq/client.js">
<link rel="modulepreload" href="../_observablehq/runtime.js">
<link rel="modulepreload" href="../_observablehq/stdlib.js">
<link rel="modulepreload" href="../_import/components/budgetAllocator.c772f675.js">
<link rel="modulepreload" href="../_import/components/miniDecarbModel.d0583510.js">
<link rel="modulepreload" href="../_npm/d3@7.9.0/_esm.js">
<link rel="modulepreload" href="../_observablehq/stdlib/duckdb.js">
<link rel="modulepreload" href="../_npm/htl@0.3.1/_esm.js">
<link rel="modulepreload" href="../_observablehq/stdlib/inputs.js">
<link rel="modulepreload" href="../_npm/@observablehq/plot@0.6.16/_esm.js">
<link rel="modulepreload" href="../_npm/@duckdb/duckdb-wasm@1.28.0/_esm.js">
<link rel="modulepreload" href="../_npm/isoformat@0.2.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-array@3.2.4/_esm.js">
<link rel="modulepreload" href="../_npm/d3-axis@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-brush@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-chord@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-color@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-contour@4.0.2/_esm.js">
<link rel="modulepreload" href="../_npm/d3-delaunay@6.0.4/_esm.js">
<link rel="modulepreload" href="../_npm/d3-dispatch@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-drag@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-dsv@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-ease@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-fetch@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-force@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-format@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-geo@3.1.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-hierarchy@3.1.2/_esm.js">
<link rel="modulepreload" href="../_npm/d3-interpolate@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-path@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-polygon@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-quadtree@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-random@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-scale@4.0.2/_esm.js">
<link rel="modulepreload" href="../_npm/d3-scale-chromatic@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-selection@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-shape@3.2.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-time@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-time-format@4.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-timer@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-transition@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-zoom@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/interval-tree-1d@1.0.4/_esm.js">
<link rel="modulepreload" href="../_npm/apache-arrow@18.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/internmap@2.0.3/_esm.js">
<link rel="modulepreload" href="../_npm/delaunator@5.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/binary-search-bounds@2.0.5/_esm.js">
<link rel="modulepreload" href="../_npm/tslib@2.8.1/_esm.js">
<link rel="modulepreload" href="../_npm/flatbuffers@24.3.25/_esm.js">
<link rel="modulepreload" href="../_npm/robust-predicates@3.0.2/_esm.js">
<script type="module">

import {define} from "../_observablehq/client.js";
import {registerFile, FileAttachment} from "../_observablehq/stdlib.js";
import {registerTable} from "../_observablehq/stdlib/duckdb.js";

registerFile("./../data/oxford_decarbonisation_data.parquet", {"name":"./../data/oxford_decarbonisation_data.parquet","path":"../_file/data/oxford_decarbonisation_data.28ee7510.parquet","lastModified":1731543891057});
registerTable("oxford", FileAttachment("../data/oxford_decarbonisation_data.parquet"));

define({id: "bda9fba7", outputs: ["BudgetAllocator","MiniDecarbModel"], body: async () => {
const [{BudgetAllocator}, {MiniDecarbModel}] = await Promise.all([import("../_import/components/budgetAllocator.c772f675.js"), import("../_import/components/miniDecarbModel.d0583510.js")]);

return {BudgetAllocator,MiniDecarbModel};
}});

define({id: "ec01b706", inputs: ["Mutable"], outputs: ["useState","selected","setSelected"], body: (Mutable) => {
function useState(value) {
  const state = Mutable(value);
  const setState = (value) => (state.value = value);
  return [state, setState];
}
const [selected, setSelected] = useState({});
return {useState,selected,setSelected};
}});

define({id: "d22197ed", inputs: ["sql"], outputs: ["oxford_data"], body: async (sql) => {
const oxford_data = await sql`  SELECT DISTINCT
    "UPRN" AS id,
    "LSOA code" AS lsoa,
    "MSOA code" AS msoa,
    "Air Source Heat Pump Potential_Building Size (m^2)" AS building_area,
    "Air Source Heat Pump Potential_Garden Area (m^2)" AS garden_area,
    "Air Source Heat Pump Potential_Overall Suitability Rating" AS ashp_suitability,
    "Air Source Heat Pump Potential_Recommended Heat Pump Size [kW]" AS ashp_size,
    "Low Carbon Technology Costs_Air Source Heat Pump - Labour" AS ashp_labour,
    "Low Carbon Technology Costs_Air Source Heat Pump - Material" AS ashp_material,
    "Low Carbon Technology Costs_Air Source Heat Pump - Total" AS ashp_total,
    "Domestic Ground Source Heat Pump Potential_Overall Suitability Rating" AS gshp_suitability,
    "Domestic Ground Source Heat Pump Potential_Recommended Heat Pump Size [kW]" AS gshp_size,
    "Low Carbon Technology Costs_Ground Source Heat Pump - Labour" AS gshp_labour,
    "Low Carbon Technology Costs_Ground Source Heat Pump - Materials" AS gshp_material,
    "Low Carbon Technology Costs_Ground Source Heat Pump - Total" AS gshp_total,
    "Domestic Heat Demand_Annual Heat Demand (kWh)" AS heat_demand,
    "Domestic Insulation Potential_EPC Rating" AS insulation_rating,
    "Domestic Insulation Potential_Insulation - Cavity Wall" AS insulation_cwall,
    "Low Carbon Technology Costs_Insulation - Cavity Wall - Labour" AS insulation_cwall_labour,
    "Low Carbon Technology Costs_Insulation - Cavity Wall  - Materials" AS insulation_cwall_materials,
    "Low Carbon Technology Costs_Insulation - Cavity Wall - Total" AS insulation_cwall_total,
    "Domestic Insulation Potential_Insulation - External Wall" AS insulation_ewall,
    "Low Carbon Technology Costs_Insulation - External Wall - Labour" AS insulation_ewall_labour,
    "Low Carbon Technology Costs_Insulation - External Wall - Material" AS insulation_ewall_materials,
    "Low Carbon Technology Costs_Insulation - External Wall - Total" AS insulation_ewall_total,
    "Domestic Insulation Potential_Insulation - Roof" AS insulation_roof,
    "Low Carbon Technology Costs_Insulation - Loft - Labour" AS insulation_roof_labour,
    "Low Carbon Technology Costs_Insulation - Loft - Material" AS insulation_roof_materials,
    "Low Carbon Technology Costs_Insulation - Loft - Total" AS insulation_roof_total,
    "Domestic Insulation Potential_Insulation - Under Floor" AS insulation_floor,
    "Low Carbon Technology Costs_Insulation - Under Floor - Labour" AS insulation_floor_labour,
    "Low Carbon Technology Costs_Insulation - Under Floor - Material" AS insulation_floor_materials,
    "Low Carbon Technology Costs_Insulation - Under Floor- Total" AS insulation_floor_total,
    "Domestic PV Potential_Overall Suitability" AS pv_suitability,
    "Domestic PV Potential_Recommended Array Size [kW]" AS pv_size,
    "Domestic PV Potential_Annual Generation [kWh]" AS pv_generation,
    "Low Carbon Technology Costs_Rooftop PV - Labour" AS pv_labour,
    "Low Carbon Technology Costs_Rooftop PV - Materials" AS pv_material,
    "Low Carbon Technology Costs_Rooftop PV - Total" AS pv_total,
    "Substation Name" AS substation_name,
    "Substation - CapacityRating" AS substation_capacity_rating,
    "Substation - Peakload" AS substation_peakload,
    "Substation - Headroom" AS substation_headroom,
    "Substation - % headroom" AS substation_headroom_pct,
    "Substation - Demand_rag" AS substation_demand
FROM oxford b;`;
return {oxford_data};
}});

define({id: "2adb250b", inputs: ["oxford_data"], outputs: ["newBuildings","columns"], body: (oxford_data) => {
const newBuildings = [...oxford_data];
const columns = Object.keys(newBuildings[0]);
return {newBuildings,columns};
}});

define({id: "5c004f34", inputs: ["view","Inputs","html","Event","Generators","display"], outputs: ["total_budget","start_year","projectLength","project_length","allocationType"], body: (view,Inputs,html,Event,Generators,display) => {
// Starting year
const total_budget = view(
  Inputs.text({
    label: html`<b>Total Budget</b>`,
    placeholder: "Available Budget in GBP",
    value: 100_000_000,
    submit: true,
  })
);

// Starting year
const start_year = view(
  Inputs.text({
    label: html`<b>Start Year</b>`,
    placeholder: "Starting year?",
    value: 2024,
    submit: true,
  })
);

// Project length
const projectLength = Inputs.range([0, 20], {
  label: html`<b>Project length in years</b>`,
  step: 1,
  value: 10,
});
projectLength.number.style["max-width"] = "60px";
Object.assign(projectLength, {
  oninput: (event) => event.isTrusted && event.stopImmediatePropagation(),
  onchange: (event) => event.currentTarget.dispatchEvent(new Event("input")),
});
const project_length = Generators.input(projectLength);
display(projectLength);

// Allocation type
const allocationType = view(
  Inputs.radio(["linear", "sqrt", "exp", "cubic"], {
    label: html`<b>Allocation Type</b>`,
    value: "linear",
  })
);
return {total_budget,start_year,projectLength,project_length,allocationType};
}});

define({id: "cc54eba5", inputs: ["BudgetAllocator","total_budget","start_year","project_length"], outputs: ["allocator"], body: (BudgetAllocator,total_budget,start_year,project_length) => {
const allocator = new BudgetAllocator(
  total_budget,
  Number(start_year),
  Number(project_length)
);
return {allocator};
}});

define({id: "d8a2d83b", inputs: ["allocationType","allocator","setSelected","display"], outputs: ["initialAllocations","svg","getAllocations"], body: (allocationType,allocator,setSelected,display) => {
let initialAllocations;
if (allocationType === "linear") {
  initialAllocations = allocator.allocateLinear();
} else {
  initialAllocations = allocator.allocateCustom(allocationType);
}

// linear allocation
// const linearAllocation = allocator.allocateLinear();
// display(linearAllocation);
const { svg, getAllocations } = allocator.visualise(
  initialAllocations,
  (changes) => {
    // console.log("data changed:", changes);
    setSelected(changes);
  }
);
display(svg);
return {initialAllocations,svg,getAllocations};
}});

define({id: "79b75dc9", inputs: ["allocationType","selected","getAllocations","initialAllocations"], outputs: ["allocations"], body: (allocationType,selected,getAllocations,initialAllocations) => {
allocationType;
const allocations = selected ? getAllocations(selected) : initialAllocations;
// display(selected);
// display(allocations);
return {allocations};
}});

define({id: "f7665dd7", inputs: ["start_year","allocations"], outputs: ["addTechConfig","addPriority","listOfTech","config"], body: (start_year,allocations) => {
function addTechConfig(techConfig) {
  config.tech = {
    name: techConfig.name,
    config: techConfig.config,
  };
}

function addPriority(name, order = "asc") {
  const newPriority = {
    name: name,
    order: order,
  };

  config.priorities.push(newPriority);
}

const listOfTech = {
  ASHP: {
    name: "ASHP",
    config: {
      suitabilityKey: "ashp_suitability",
      labourKey: "ashp_labour",
      materialKey: "ashp_material",
      savingsKey: "heat_demand", // will be calculated from a lookup and stored in the building data
    },
  },
  PV: {
    name: "PV",
    config: {
      suitabilityKey: "pv_suitability",
      labourKey: "pv_labour",
      materialKey: "pv_material",
      savingsKey: "solar_generation",
    },
  },
};

let config = {
  initial_year: Number(start_year),
  rolledover_budget: 0,
  yearly_budgets: allocations.map((item) => item.budget),
  tech: {},
  priorities: [],
};

// update config here
addTechConfig(listOfTech.ASHP);
// addPriority("substation_headroom", "asc");
return {addTechConfig,addPriority,listOfTech,config};
}});

define({id: "203a2375", inputs: ["display","config"], body: (display,config) => {
// display("Model Configuration");
display(config);
}});

define({id: "79324e46", body: () => {
// const configASHP = {
//   initial_year: 2024,
//   rolledover_budget: 50_000_000,
//   yearly_budgets: [1_200_000, 30000, 20000, 5000, 3000, 20000], // this will be assigned from budgetAllocator
//   tech: {
//     name: "ASHP",
//     config: {
//       suitabilityKey: "ashp_suitability",
//       labourKey: "ashp_labour",
//       materialKey: "ashp_material",
//       savingsKey: "heat_demand", // will be calculated from a lookup and stored in the building data
//     },
//   },
//   priorities: [
//     {
//       name: "substation_headroom", //sort by substation headroom
//       order: "asc",
//     },
//   ],
// };
// display("configuration SAHP");

// display(configASHP);
}});

define({id: "3141ed6a", inputs: ["MiniDecarbModel","config","newBuildings"], outputs: ["modelASHP","results"], body: (MiniDecarbModel,config,newBuildings) => {
// For priority rules:
// // Categorical priority
// model.addPriorityRuleCustom({
//   attribute: 'multideprivation',
//   scoreFunction: (value) => ({
//     'deprived': 1000,
//     'not-deprived': 0
//   })[value] || 0
// });

// // Numeric threshold priority
// model.addPriorityRuleCustom({
//   attribute: 'fuel_poverty',
//   scoreFunction: (value) => value > 0.5 ? 500 : 0,
//   weight: 2.0
// });

// // Complex scoring function
// model.addPriorityRuleCustom({
//   attribute: 'energy_rating',
//   scoreFunction: (value) => {
//     const ratings = {'A': 0, 'B': 200, 'C': 400, 'D': 600, 'E': 800, 'F': 1000};
//     return ratings[value] || 0;
//   }
// });
const modelASHP = new MiniDecarbModel(config, newBuildings);
// modelASHP.addBuildingFilter(
//   (b) => b.properties["substation_headroom"] >= 500,
//   "Substation Headroom >= 500"
// );

// modelASHP.addPriorityRuleCustom({
//   attribute: "substation_capacity_rating",
//   scoreFunction: (value) =>
//     ({
//       800: 500,
//       1500: 1000,
//     }[value] || 0),
// });

modelASHP.runModel();
const results = modelASHP.getRecap();
// display(results);
return {modelASHP,results};
}});

define({id: "0ed95c73", inputs: ["results"], outputs: ["data"], body: (results) => {
const data = Object.entries(results.yearlyStats).map(([year, stats]) => ({
  year: +year,
  budgetSpent: stats.budgetSpent,
  buildingsIntervened: stats.buildingsIntervened,
}));
return {data};
}});

define({id: "06fe437e", inputs: ["d3","data","display","Plot"], outputs: ["v1","v2","y2"], body: (d3,data,display,Plot) => {
const v1 = (d) => d.budgetSpent;
const v2 = (d) => d.buildingsIntervened;
const y2 = d3.scaleLinear(d3.extent(data, v2), [0, d3.max(data, v1)]);

display(
  Plot.plot({
    x: {
      tickFormat: "", // display years without commas
      label: "Year",
    },
    y: {
      axis: "left",
      label: "Budget Spent (Â£)",
    },
    marks: [
      // Right axis for buildings intervened
      Plot.axisY(y2.ticks(), {
        color: "steelblue",
        anchor: "right",
        label: "Buildings Intervened",
        y: y2,
        tickFormat: y2.tickFormat(),
      }),
      // Rule at Y=0 for budget spent line baseline
      Plot.ruleY([0]),
      // Line for budget spent
      Plot.line(data, {
        x: "year",
        y: v1,
      }),
      // Line for buildings intervened with mapped y2 scale
      Plot.line(
        data,
        Plot.mapY((D) => D.map(y2), {
          x: "year",
          y: v2,
          stroke: "steelblue",
        })
      ),
    ],
  })
);
return {v1,v2,y2};
}});

define({id: "216be021", inputs: ["display","Inputs","results"], body: (display,Inputs,results) => {
display(Inputs.table(results.allBuildings));
}});

</script>
<div id="observablehq-center">
<main id="observablehq-main" class="observablehq">
<div class="observablehq observablehq--block"><!--:bda9fba7:--></div>
<div class="observablehq observablehq--block"><!--:ec01b706:--></div>
<!-- ------------ Data ------------ -->
<div class="observablehq observablehq--block"><!--:d22197ed:--></div>
<div class="observablehq observablehq--block"><!--:2adb250b:--></div>
<h2 id="budget-allocator" tabindex="-1"><a class="observablehq-header-anchor" href="#budget-allocator">Budget Allocator</a></h2>
<div class="observablehq observablehq--block"><!--:5c004f34:--></div>
<div class="observablehq observablehq--block"><!--:cc54eba5:--></div>
<div class="observablehq observablehq--block"><!--:d8a2d83b:--></div>
<div class="observablehq observablehq--block"><!--:79b75dc9:--></div>
<h2 id="test-new-model" tabindex="-1"><a class="observablehq-header-anchor" href="#test-new-model">Test New Model</a></h2>
<div class="observablehq observablehq--block"><!--:f7665dd7:--></div>
<p>Model Configuration:</p>
<div class="observablehq observablehq--block"><!--:203a2375:--></div>
<div class="observablehq observablehq--block"><!--:79324e46:--></div>
<div class="observablehq observablehq--block"><!--:3141ed6a:--></div>
<div class="observablehq observablehq--block"><!--:0ed95c73:--></div>
<div class="observablehq observablehq--block"><!--:06fe437e:--></div>
<p>All suitable buildings, with attribute showing intervention or non-intervention:</p>
<div class="observablehq observablehq--block"><!--:216be021:--></div>
</main>
</div>
