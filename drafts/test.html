<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Test New Model | Decarbonisation Glyphmap Planner</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="../_observablehq/theme-air,near-midnight.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="../_observablehq/theme-air,near-midnight.css">
<link rel="modulepreload" href="../_observablehq/client.js">
<link rel="modulepreload" href="../_observablehq/runtime.js">
<link rel="modulepreload" href="../_observablehq/stdlib.js">
<link rel="modulepreload" href="../_import/components/glyph-designs/timeGlyph.a1969fec.js">
<link rel="modulepreload" href="../_import/components/decarbonisationModel.ce39898f.js">
<link rel="modulepreload" href="../_npm/d3@7.9.0/_esm.js">
<link rel="modulepreload" href="../_observablehq/stdlib/duckdb.js">
<link rel="modulepreload" href="../_npm/@duckdb/duckdb-wasm@1.28.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-array@3.2.4/_esm.js">
<link rel="modulepreload" href="../_npm/d3-axis@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-brush@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-chord@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-color@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-contour@4.0.2/_esm.js">
<link rel="modulepreload" href="../_npm/d3-delaunay@6.0.4/_esm.js">
<link rel="modulepreload" href="../_npm/d3-dispatch@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-drag@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-dsv@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-ease@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-fetch@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-force@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-format@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-geo@3.1.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-hierarchy@3.1.2/_esm.js">
<link rel="modulepreload" href="../_npm/d3-interpolate@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-path@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-polygon@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-quadtree@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-random@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-scale@4.0.2/_esm.js">
<link rel="modulepreload" href="../_npm/d3-scale-chromatic@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-selection@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-shape@3.2.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-time@3.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-time-format@4.1.0/_esm.js">
<link rel="modulepreload" href="../_npm/d3-timer@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-transition@3.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/d3-zoom@3.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/apache-arrow@19.0.0/_esm.js">
<link rel="modulepreload" href="../_npm/internmap@2.0.3/_esm.js">
<link rel="modulepreload" href="../_npm/delaunator@5.0.1/_esm.js">
<link rel="modulepreload" href="../_npm/tslib@2.8.1/_esm.js">
<link rel="modulepreload" href="../_npm/flatbuffers@24.12.23/_esm.js">
<link rel="modulepreload" href="../_npm/robust-predicates@3.0.2/_esm.js">
<script type="module">

import {define} from "../_observablehq/client.js";
import {registerFile, FileAttachment} from "../_observablehq/stdlib.js";
import {registerTable} from "../_observablehq/stdlib/duckdb.js";

registerFile("./../data/oxford_decarbonisation_data.parquet", {"name":"./../data/oxford_decarbonisation_data.parquet","path":"../_file/data/oxford_decarbonisation_data.3c946953.parquet","lastModified":1737979215358});
registerTable("oxford", FileAttachment("../data/oxford_decarbonisation_data.parquet"));

define({id: "7cc7faba", outputs: ["TimeGlyph","GlyphCollection","DecarbonisationModel"], body: async () => {
const [{TimeGlyph, GlyphCollection}, {DecarbonisationModel}] = await Promise.all([import("../_import/components/glyph-designs/timeGlyph.a1969fec.js"), import("../_import/components/decarbonisationModel.ce39898f.js")]);
// import { Model } from "./components/model.js";
return {TimeGlyph,GlyphCollection,DecarbonisationModel};
}});

define({id: "d22197ed", inputs: ["sql"], outputs: ["oxford_data"], body: async (sql) => {
const oxford_data = await sql`  SELECT DISTINCT
    "UPRN" AS id,
    "LSOA code" AS lsoa,
    "MSOA code" AS msoa,
    "Air Source Heat Pump Potential_Building Size (m^2)" AS building_area,
    "Air Source Heat Pump Potential_Garden Area (m^2)" AS garden_area,
    "Air Source Heat Pump Potential_Overall Suitability Rating" AS ashp_suitability,
    "Air Source Heat Pump Potential_Recommended Heat Pump Size [kW]" AS ashp_size,
    "Low Carbon Technology Costs_Air Source Heat Pump - Labour" AS ashp_labour,
    "Low Carbon Technology Costs_Air Source Heat Pump - Material" AS ashp_material,
    "Low Carbon Technology Costs_Air Source Heat Pump - Total" AS ashp_total,
    "Domestic Ground Source Heat Pump Potential_Overall Suitability Rating" AS gshp_suitability,
    "Domestic Ground Source Heat Pump Potential_Recommended Heat Pump Size [kW]" AS gshp_size,
    "Low Carbon Technology Costs_Ground Source Heat Pump - Labour" AS gshp_labour,
    "Low Carbon Technology Costs_Ground Source Heat Pump - Materials" AS gshp_material,
    "Low Carbon Technology Costs_Ground Source Heat Pump - Total" AS gshp_total,
    "Domestic Heat Demand_Annual Heat Demand (kWh)" AS heat_demand,
    "Domestic Insulation Potential_EPC Rating" AS insulation_rating,
    "Domestic Insulation Potential_Insulation - Cavity Wall" AS insulation_cwall,
    "Low Carbon Technology Costs_Insulation - Cavity Wall - Labour" AS insulation_cwall_labour,
    "Low Carbon Technology Costs_Insulation - Cavity Wall  - Materials" AS insulation_cwall_materials,
    "Low Carbon Technology Costs_Insulation - Cavity Wall - Total" AS insulation_cwall_total,
    "Domestic Insulation Potential_Insulation - External Wall" AS insulation_ewall,
    "Low Carbon Technology Costs_Insulation - External Wall - Labour" AS insulation_ewall_labour,
    "Low Carbon Technology Costs_Insulation - External Wall - Material" AS insulation_ewall_materials,
    "Low Carbon Technology Costs_Insulation - External Wall - Total" AS insulation_ewall_total,
    "Domestic Insulation Potential_Insulation - Roof" AS insulation_roof,
    "Low Carbon Technology Costs_Insulation - Loft - Labour" AS insulation_roof_labour,
    "Low Carbon Technology Costs_Insulation - Loft - Material" AS insulation_roof_materials,
    "Low Carbon Technology Costs_Insulation - Loft - Total" AS insulation_roof_total,
    "Domestic Insulation Potential_Insulation - Under Floor" AS insulation_floor,
    "Low Carbon Technology Costs_Insulation - Under Floor - Labour" AS insulation_floor_labour,
    "Low Carbon Technology Costs_Insulation - Under Floor - Material" AS insulation_floor_materials,
    "Low Carbon Technology Costs_Insulation - Under Floor- Total" AS insulation_floor_total,
    "Domestic PV Potential_Overall Suitability" AS pv_suitability,
    "Domestic PV Potential_Recommended Array Size [kW]" AS pv_size,
    "Domestic PV Potential_Annual Generation [kWh]" AS pv_generation,
    "Low Carbon Technology Costs_Rooftop PV - Labour" AS pv_labour,
    "Low Carbon Technology Costs_Rooftop PV - Materials" AS pv_material,
    "Low Carbon Technology Costs_Rooftop PV - Total" AS pv_total,
    "Substation Name" AS substation_name,
    "Substation - CapacityRating" AS substation_capacity_rating,
    "Substation - Peakload" AS substation_peakload,
    "Substation - Headroom" AS substation_headroom,
    "Substation - % headroom" AS substation_headroom_pct,
    "Substation - Demand_rag" AS substation_demand
FROM oxford b;`;
return {oxford_data};
}});

define({id: "e990e608", inputs: ["oxford_data"], outputs: ["newBuildings"], body: (oxford_data) => {
const newBuildings = [...oxford_data];
return {newBuildings};
}});

define({id: "79acebbe", outputs: ["modelSpec"], body: () => {
// model specifications
const modelSpec = {
  initial_year: 2024,
  target_years: 2,
  overall_budget:  50_000,
  uncapped_mode: false,
  technologies: [
    {
      name: "PV",
      allocation: 0.4,
      config: {
        scoreFn: (building) => {
          if (!building.pv_suitability) return 0;
          return building.pv_generation / building.pv_size;
        },
        suitabilityKey: "pv_suitability",
        labourKey: "pv_labour",
        materialKey: "pv_material",
        savingsKey: "pv_generation",
      },
    },
    {
      name: "ASHP",
      allocation: 0.6,
      config: {
        scoreFn: (building) => {
          if (!building.ashp_suitability) return 0;
          return building.heat_demand / building.ashp_size;
        },
        suitabilityKey: "ashp_suitability",
        labourKey: "ashp_labour",
        materialKey: "ashp_material",
        savingsKey: "heat_demand",
      },
    },
  ],
  // priorityRules: [
  //       {attribute: 'deprivation_index', order: 'desc'},
  //       {attribute: 'fuel_poverty', order: 'desc'}
  // ]
};
return {modelSpec};
}});

define({id: "3ab11a0a", inputs: ["DecarbonisationModel","modelSpec","newBuildings","display"], outputs: ["model"], body: (DecarbonisationModel,modelSpec,newBuildings,display) => {
const model = new DecarbonisationModel(modelSpec, newBuildings);
model.addBuildingFilter((b) => b.properties.substation_headroom >= 500); // custom filtering
// model.addPriorityRule('multideprivation', 'asc'); // arbitrary priority rule

model.runModel();

// console.log("Yearly Interventions in 2024:", model.getYearInterventions(2024));

// display(model.getYearInterventions(2024));
// Get interventions grouped by year and technology
display(model.getGroupedYearTechInterventions()[2024]);

// Custom groupings interventions
// display(model.getInterventions()
//     .groupBy('year')
//     .groupBy('technology')
//     .groupBy('buildingProperties.lsoa')
//     .all()
//     );

// Get final stats
display(model.getFinalStats());
return {model};
}});

define({id: "300bf53e", inputs: ["DecarbonisationModel","modelSpec","newBuildings","display"], outputs: ["uncappedModel"], body: (DecarbonisationModel,modelSpec,newBuildings,display) => {
// testing uncapped
const uncappedModel = new DecarbonisationModel(
  {
    ...modelSpec,
    overall_budget: null,
    uncapped_mode: true,
  },
  newBuildings
);

uncappedModel.runModel();

// console.log(
//   "Yearly Interventions in 2024:",
//   uncappedModel.getYearInterventions(2024)
// );

// // Get interventions grouped by year and technology
// console.log(uncappedModel.getGroupedInterventions());

// // Get final stats
// console.log(uncappedModel.getFinalStats());

display(uncappedModel.getFinalStats());
return {uncappedModel};
}});

</script>
<div id="observablehq-center">
<main id="observablehq-main" class="observablehq">
<div class="observablehq observablehq--block"><!--:7cc7faba:--></div>
<h2 id="test-new-model" tabindex="-1"><a class="observablehq-header-anchor" href="#test-new-model">Test New Model</a></h2>
<div class="observablehq observablehq--block"><!--:d22197ed:--></div>
<div class="observablehq observablehq--block"><!--:e990e608:--></div>
<div class="observablehq observablehq--block"><!--:79acebbe:--></div>
<div class="observablehq observablehq--block"><!--:3ab11a0a:--></div>
<h2 id="uncapped-model" tabindex="-1"><a class="observablehq-header-anchor" href="#uncapped-model">Uncapped Model</a></h2>
<div class="observablehq observablehq--block"><!--:300bf53e:--></div>
</main>
</div>
